From beea3df351b797e4a5c5e4ec5807ad90ad0d1619 Mon Sep 17 00:00:00 2001
From: hmz007 <hmz007@gmail.com>
Date: Mon, 19 Oct 2020 10:48:51 +0800
Subject: [PATCH 53/73] partitions/rk: minor fixes for v5.9 and enable it

Signed-off-by: hmz007 <hmz007@gmail.com>
---
 block/partitions/check.h | 1 +
 block/partitions/core.c  | 3 +++
 block/partitions/rk.c    | 4 ++++
 block/partitions/rk.h    | 2 --
 4 files changed, 8 insertions(+), 2 deletions(-)

diff --git a/block/partitions/check.h b/block/partitions/check.h
index c577e9ee67f0..21c78a0c5a6b 100644
--- a/block/partitions/check.h
+++ b/block/partitions/check.h
@@ -69,5 +69,6 @@ int sgi_partition(struct parsed_partitio
 int sun_partition(struct parsed_partitions *state);
 int sysv68_partition(struct parsed_partitions *state);
 int ultrix_partition(struct parsed_partitions *state);
+int rkpart_partition(struct parsed_partitions *state);
 
 int parse_fit_partitions(struct parsed_partitions *state, u64 start_sector, u64 nr_sectors, int *slot, int add_remain);
diff --git a/block/partitions/core.c b/block/partitions/core.c
index 722406b841df..7a10808c5dc2 100644
--- a/block/partitions/core.c
+++ b/block/partitions/core.c
@@ -81,6 +81,9 @@ static int (*check_part[])(struct parsed_partitions *) = {
 #endif
 #ifdef CONFIG_SYSV68_PARTITION
 	sysv68_partition,
+#endif
+#ifdef CONFIG_RK_PARTITION
+	rkpart_partition,
 #endif
 	NULL
 };
diff --git a/block/partitions/rk.c b/block/partitions/rk.c
index 398370714db0..09a2751d1e2d 100644
--- a/block/partitions/rk.c
+++ b/block/partitions/rk.c
@@ -289,6 +289,10 @@ int rkpart_partition(struct parsed_partitions *state)
 	if (!(state->bdev->bd_disk->flags & GENHD_FL_RKPART))
 		return 0;
 
+	/* reserved for backup GPT, align to 4M */
+	n -= 33;
+	n &= ~(0x2000LLU-1);
+
 	/* Fixme: parameter should be coherence with part table */
 	cmdline = strstr(saved_command_line, "mtdparts=");
 	if (!cmdline)
diff --git a/block/partitions/rk.h b/block/partitions/rk.h
index 3840f6efcced..a2541dd261c7 100644
--- a/block/partitions/rk.h
+++ b/block/partitions/rk.h
@@ -45,6 +45,4 @@ struct cmdline_rk_partition {
 	struct rk_partition *parts;
 };
 
-extern int rkpart_partition(struct parsed_partitions *state);
-
 #endif
-- 
2.31.1

